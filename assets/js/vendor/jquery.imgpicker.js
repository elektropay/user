(function(e,t,n,r){function a(t,n){this.options=e.extend({},s,n);this.container=e(t);this.init()}e.support.xhrUpload=!!(t.XMLHttpRequest&&t.File&&t.FileReader&&t.FileList&&t.Blob&&t.FormData);e.support.getUserMedia=!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia);e.support.Jcrop=!!e.Jcrop;e.support.Webcam=!!t.Webcam;var i="imgPicker",s={url:"server/upload.php",crop:true,aspectRatio:null,minSize:null,maxSize:null,setSelect:null,swf:"assets/webcam.swf",swfSize:[470,350],data:{},messages:{selectimg:"Please select a image to upload",parsererror:"Invalid response",webcamerror:"Webcam Error: ",uploading:"Uploading...",error:"Unexpected error",datauri:"Cannot locate image format in Data URI",webcamjs:"Flash webcam not found",upgrade:"This feature is not available in this browser",loading:"Loading image...",saving:"Saving...",jcrop:"jQuery Jcrop not found",minCropWidth:"Crop selection requires a minimum width of ",maxCropWidth:"Crop selection exceeds maximum width of ",minCropHeight:"Crop selection requires a height of ",maxCropHeight:"Crop selection exceeds maximum height of ",img404:"Error 404: No image was found"}},o,u=0;a.prototype={init:function(){this.elem(".ip-upload").on("change","input",e.proxy(this.upload,this));this.elem(".ip-webcam").on("click",e.proxy(this.webcam,this));this.elem(".ip-edit").on("click",e.proxy(this.edit,this));this.elem(".ip-delete").on("click",e.proxy(this._delete,this));this.elem(".ip-cancel").on("click",e.proxy(this.reset,this));if(this.options.dropZone===r)this.options.dropZone=this.container;var t=this,n=e('[data-ip-modal="#'+this.container.attr("id")+'"]');if(n.length){this.container.on({"show.ip.modal":function(){t.container.fadeIn(150,function(){e(this).trigger("shown.ip.modal",t)})},"hide.ip.modal":function(){t.container.fadeOut(150,function(){t.reset();e(this).trigger("hidden.ip.modal",t)})}});n.on("click",function(e){e.preventDefault();t.modal("show");t.elem(".ip-close").off().on("click",function(){t.modal("hide")})});if(this.options.dropZone===r)this.options.dropZone=this.elem(".ip-modal-content")}if(this.options.dropZone){this.options.dropZone.on("dragenter",function(e){e.stopPropagation();e.preventDefault()}).on("dragover",function(e){e.stopPropagation();e.preventDefault()}).on("drop",function(e){e.preventDefault();if(e.originalEvent.dataTransfer.files&&e.originalEvent.dataTransfer.files[0]){t.reset();t.handleFileUpload(e.originalEvent.dataTransfer.files[0])}})}if(this.options.loadComplete)this.load()},modal:function(e){this.container.trigger(e+".ip.modal")},load:function(){var t=this;e.ajax({url:this.options.url,dataType:"json",data:{action:"load",data:this.options.data},success:function(e){t.dispatch("loadComplete",e)}})},upload:function(t){this.reset();if(!e.support.xhrUpload)return this.iframeTransport(t);if(t.target.files&&t.target.files[0])this.handleFileUpload(t.target.files[0]);e(t.target).val("")},iframeTransport:function(t){var n,r,i=this,s=e(t.target),o=s.parent(),a=s.clone();this.dispatch("uploadProgress",100);n=e('<iframe name="iframe-transport-'+(u+1)+'" style="display:none;"></iframe>').appendTo("body").on("load",function(){i.dispatch("uploadProgressComplete",function(){try{var t=e.parseJSON(n.contents().find("body").html())}catch(s){}if(t){i.alert("","hide");i.uploadComplete(t)}else i.alert(i.i18n("parsererror"),"error");setTimeout(function(){n.remove();r.remove();o.append(a)},100)})});r=e('<form style="display:none;"><form/>');r.prop("method","POST");r.prop("action",this.options.url);r.prop("target",n.prop("name"));r.prop("enctype","multipart/form-data");r.prop("encoding","multipart/form-data");r.prop({action:this.options.url,target:n.prop("name")});r.append(s);r.append('<input type="hidden" name="action" value="upload"/>');if(this.options.data)e.each(this.options.data,function(t,n){e('<input type="hidden"/>').prop("name","data["+t+"]").val(n).appendTo(r)});r.appendTo("body").trigger("submit")},webcam:function(){this.reset();if(!e.support.getUserMedia)return this.flashWebcam();var r=e("<video autoplay></video>");this.elem(".ip-preview").html(r);navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var i=this;navigator.getUserMedia({video:true},function(e){r.attr("src",t.URL.createObjectURL(o=e));i.elem(".ip-preview, .ip-cancel").show();i.elem(".ip-capture").on("click",function(){var e=n.createElement("canvas"),t=e.getContext("2d");e.width=r[0].videoWidth;e.height=r[0].videoHeight;t.drawImage(r[0],0,0);i.reset();i.handleFileUpload(e.toDataURL("image/jpeg"))}).show()},function(e){i.alert(i.i18n("webcamerror")+e.name,"error")})},flashWebcam:function(){if(!e.support.xhrUpload)return this.alert(this.i18n("upgrade"),"error");this.elem(".ip-preview").html(Webcam.getHtml(this.options.swf,this.options.swfSize)).show();var t=this;Webcam.loaded=function(){t.elem(".ip-cancel").show();t.elem(".ip-capture").on("click",function(){var e=Webcam.snap();t.reset();t.handleFileUpload(e)}).show()}},handleFileUpload:function(t){if(!t)return this.alert(this.i18n("selectimg"),"error");if(!t.name){if(!t.match(/^data\:image\/(\w+)/))return this.alert(this.i18n("datauri"),"error");var n=t.replace(/^data\:image\/\w+\;base64\,/,"");t=new Blob([this.base64DecToArr(n)],{type:"image/jpeg"})}var r=this;this.elem(".ip-upload input, .ip-webcam").prop("disabled",true),xhr=e.ajaxSettings.xhr();xhr.open("POST",this.options.url,true);xhr.upload.onprogress=function(e){if(e.lengthComputable){var t=Math.floor(e.loaded/e.total*100);r.dispatch("uploadProgress",t)}};xhr.onload=function(){setTimeout(function(){r.elem(".ip-upload input, .ip-webcam").prop("disabled",false);r.dispatch("uploadProgressComplete",function(){if(xhr.status==200){try{var t=e.parseJSON(xhr.responseText)}catch(n){}if(t){r.alert("","hide");return r.uploadComplete(t)}}r.alert(r.i18n("parsererror"),"error")})},500)};var i=new FormData;i.append("action","upload");i.append("file",t);e.each(this.options.data,function(e,t){i.append("data["+e+"]",t)});xhr.send(i)},uploadProgress:function(e){this.elem(".ip-progress").fadeIn().find(".progress-bar").css("width",e+"%")},uploadProgressComplete:function(t){this.elem(".ip-progress").fadeOut(function(){e(this).find(".progress-bar").css("width","0%");t()})},uploadComplete:function(e){if(e.error)return this.alert(this.i18n(e.error||"error"),"error");this.dispatch("uploadSuccess",e);if(this.options.crop)this.crop(e)},crop:function(t){this.reset();if(!e.support.Jcrop)return this.dispatch("alert",this.i18n("jcrop"),"error");var n=this,r=this.options.url+"?action=preview&file="+t.name+"&width=800",i=0,s,o=function(e){s=e},u={onChange:o,onRelease:o,bgColor:"white"},a=function(e){i+=e;if(Math.abs(i)>=360)i=0;f(r+"&rotate="+i)};if(this.options.aspectRatio)u.aspectRatio=this.options.aspectRatio;if(this.options.setSelect)u.setSelect=this.options.setSelect;if(this.options.minSize)u.minSize=this.options.minSize;if(this.options.maxSize)u.maxSize=this.options.maxSize;var f=function(r){r+="&rand="+(new Date).getTime();n.alert(n.i18n("loading"),"loading");var s=new Image;s.onload=function(){n.alert("","hide");n.elem(".ip-cancel").show();var s=e('<img src="'+r+'" style="visibility:hidden;">');n.elem(".ip-preview").html(s);if(Math.abs(i)==90||Math.abs(i)==270)u.trueSize=[t.height,t.width];else u.trueSize=[t.width,t.height];n.elem(".ip-preview, .ip-rotate, .ip-info, .ip-save").show();s.Jcrop(u)};s.onerror=function(){n.alert(n.i18n("img404"),"error")};s.src=r};f(r);this.elem(".ip-rotate-ccw").on("click",function(){a(-90)}).show();this.elem(".ip-rotate-cw").on("click",function(){a(90)}).show();this.elem(".ip-save").on("click",function(){e.ajax({url:n.options.url,type:"POST",dataType:"json",data:{action:"crop",image:t.name,coords:s,rotate:i,data:n.options.data},beforeSend:function(){if(!n.validateCrop(s||{}))return;n.elem(".ip-save").prop("disabled",true);n.alert(n.i18n("saving"),"loading")},success:function(e){if(e.error)return n.alert(n.i18n(e.error||"error"),"error");n.reset();n.setImage(e);n.dispatch("cropSuccess",e)},error:function(){n.alert(n.i18n("parsererror"),"error")},complete:function(){n.elem(".ip-save").prop("disabled",false)}})})},validateCrop:function(e){var t=this.options;if(t.minSize){if(t.minSize[0]&&(e.w||0)<t.minSize[0])return this.alert(this.i18n("minCropWidth")+t.minSize[0]+"px","error");if(t.maxSize[0]&&(e.w||0)>t.maxSize[0])return this.alert(this.i18n("maxCropWidth")+t.maxSize[0]+"px","error");if(t.minSize[1]&&(e.h||0)<t.minSize[1])return this.alert(this.i18n("minCropHeight")+t.minSize[1]+"px","error");if(t.maxSize[1]&&(e.h||0)>t.maxSize[1])return this.alert(this.i18n("maxCropHeight")+t.maxSize[1]+"px","error")}return true},_delete:function(){if(this.image&&this.image.name)e.post(this.options.url,{action:"delete",data:this.options.data,file:this.image.name});this.elem(".ip-delete, .ip-edit").hide();this.dispatch("deleteComplete")},edit:function(){if(this.image)this.crop(this.image)},setImage:function(e){this.image=e;this.elem(".ip-delete, .ip-edit").show()},reset:function(){this.alert("","hide");this.elem(".ip-preview").html("").hide();this.elem(".ip-save, .ip-capture, .ip-rotate-cw, .ip-rotate-ccw").off().hide();this.elem(".ip-cancel, .ip-rotate, .ip-info").hide();if(o)o.stop()},alert:function(t,n){if(this.options.alert)return this.options.alert(t,n);var r=this.container.find(".ip-alert");if(n=="hide")return r.hide();r.html(t).removeClass(n=="success"?"alert-danger alert-warning":n=="warning"||n=="loading"?"alert-danger alert-success":"alert-warning alert-danger").addClass("alert-"+(n=="success"?"success":n=="warning"||n=="loading"?"warning":"danger")).append(e('<a class="dismiss">&times;</a>').on("click",function(){r.hide()})).show()},i18n:function(e){return this.options.messages[e]||e.toString()},elem:function(e){return this.container.find(e)},dispatch:function(){var e=arguments[0].replace(/^on/i,""),t=Array.prototype.slice.call(arguments,1),n=this.options[e]||this[e];if(n){if(typeof n=="function"){n.apply(this,t);return true}}return false},b64ToUint6:function(e){return e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:e===43?62:e===47?63:0},base64DecToArr:function(e,t){var n=e.replace(/[^A-Za-z0-9\+\/]/g,""),r=n.length,i=t?Math.ceil((r*3+1>>2)/t)*t:r*3+1>>2,s=new Uint8Array(i);for(var o,u,a=0,f=0,l=0;l<r;l++){u=l&3;a|=this.b64ToUint6(n.charCodeAt(l))<<18-6*u;if(u===3||r-l===1){for(o=0;o<3&&f<i;o++,f++){s[f]=a>>>(16>>>o&24)&255}a=0}}return s}};e.fn[i]=function(t){this.each(function(){if(!e.data(this,"plugin_"+i)){e.data(this,"plugin_"+i,new a(this,t))}});return this}})(jQuery,window,document);window.Webcam={isLoaded:false,loaded:null,complete:null,error:null,getHtml:function(e,t){return'<object id="webcam_movie_obj" type="application/x-shockwave-flash" width="'+t[0]+'" height="'+t[1]+'"><param name="allowScriptAccess" value="always"/><param name="allowFullScreen" value="false"/><param name="movie" value="'+e+'"/><param name="wmode" value="transparent"/><param name="flashvars" value="width='+t[0]+"&height="+t[1]+"&dest_width="+t[0]*1.5+"&dest_height="+t[1]*1.5+'&image_format=jpeg&jpeg_quality=100&force_flash=false">'+"</object>"},snap:function(){if(!this.isLoaded)return alert("JPEGCam ERROR: Movie is not loaded yet");var e=document.getElementById("webcam_movie_obj"),t="";if(!e)alert("JPEGCam ERROR: Cannot locate movie #webcam_movie_obj in DOM");try{t="data:image/jpeg;base64,"+e._snap()}catch(n){}return t},flashNotify:function(e,t){switch(e){case"flashLoadComplete":this.isLoaded=true;break;case"cameraLive":this.loaded();break;case"error":this.error(t);break}}}